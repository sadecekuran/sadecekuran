<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Galactic - QR Kod Tarayıcı ve Oluşturucu</title>
  <style>
    :root {
      --bg-primary: #000000;
      --bg-secondary: #111111;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --text-muted: #888888;
      --border-color: #333333;
      --accent-light: #ffffff;
      --accent-dark: #000000;
      --shadow-light: rgba(255, 255, 255, 0.1);
      --shadow-dark: rgba(0, 0, 0, 0.5);
      --gradient-primary: linear-gradient(135deg, #ffffff, #cccccc);
      --gradient-secondary: linear-gradient(135deg, #333333, #111111);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Galaxy Animation Background */
    .galaxy-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -2;
      background: radial-gradient(ellipse at center, #111111 0%, #000000 100%);
    }

    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }

    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: twinkle 3s infinite;
    }

    .star:nth-child(odd) {
      animation-delay: 1s;
    }

    .star:nth-child(3n) {
      animation-delay: 2s;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    .nebula {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: 
        radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 60% 20%, rgba(255, 255, 255, 0.04) 0%, transparent 50%);
      animation: nebula-drift 20s infinite linear;
    }

    @keyframes nebula-drift {
      0% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(180deg) scale(1.1); }
      100% { transform: rotate(360deg) scale(1); }
    }

    /* Main Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      position: relative;
      z-index: 10;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 3rem;
      animation: fadeInDown 1s ease-out;
    }

    .title {
      font-size: clamp(2.5rem, 6vw, 4rem);
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1rem;
      text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
    }

    .subtitle {
      font-size: 1.2rem;
      color: var(--text-secondary);
      font-weight: 300;
      letter-spacing: 0.5px;
    }

    /* Mode Toggle */
    .mode-toggle {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
      animation: fadeInUp 1s ease-out 0.2s both;
    }

    .toggle-container {
      background: rgba(17, 17, 17, 0.5);
      backdrop-filter: blur(10px);
      border-radius: 50px;
      padding: 4px;
      border: 1px solid var(--border-color);
      display: flex;
    }

    .toggle-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 46px;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggle-btn.active {
      background: var(--gradient-primary);
      color: var(--bg-primary);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
    }

    .toggle-btn:hover:not(.active) {
      color: var(--text-primary);
    }

    /* Cards */
    .card {
      background: rgba(17, 17, 17, 0.5);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      backdrop-filter: blur(10px);
      box-shadow: 
        0 8px 32px var(--shadow-dark),
        inset 0 1px 0 var(--shadow-light);
      animation: fadeInUp 1s ease-out 0.4s both;
    }

    .card-title {
      font-size: 1.5rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 1rem;
    }

    .card-subtitle {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: 2rem;
    }

    /* Camera Section */
    .camera-container {
      position: relative;
      aspect-ratio: 16/9;
      background: var(--bg-primary);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 1.5rem;
      border: 2px solid var(--border-color);
    }

    .camera-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      flex-direction: column;
      gap: 1rem;
    }

    .camera-icon {
      width: 4rem;
      height: 4rem;
      opacity: 0.5;
    }

    /* Scanning Overlay */
    .scanning-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scan-frame {
      width: 250px;
      height: 250px;
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 12px;
      position: relative;
    }

    .scan-corner {
      position: absolute;
      width: 30px;
      height: 30px;
      border: 4px solid white;
    }

    .scan-corner.top-left {
      top: -2px;
      left: -2px;
      border-right: none;
      border-bottom: none;
      border-radius: 12px 0 0 0;
    }

    .scan-corner.top-right {
      top: -2px;
      right: -2px;
      border-left: none;
      border-bottom: none;
      border-radius: 0 12px 0 0;
    }

    .scan-corner.bottom-left {
      bottom: -2px;
      left: -2px;
      border-right: none;
      border-top: none;
      border-radius: 0 0 0 12px;
    }

    .scan-corner.bottom-right {
      bottom: -2px;
      right: -2px;
      border-left: none;
      border-top: none;
      border-radius: 0 0 12px 0;
    }

    .scan-line {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, white, transparent);
      animation: scan-animation 2s linear infinite;
    }

    @keyframes scan-animation {
      0% { transform: translateY(0); }
      100% { transform: translateY(246px); }
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      justify-content: center;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: var(--bg-primary);
    }

    .btn-primary:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 10px 25px rgba(255, 255, 255, 0.2);
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }

    .btn-secondary:hover {
      border-color: var(--text-primary);
      color: var(--text-primary);
    }

    .btn-danger {
      background: #dc2626;
      color: white;
    }

    .btn-danger:hover {
      background: #b91c1c;
      transform: translateY(-2px);
    }

    .btn-center {
      display: flex;
      justify-content: center;
    }

    /* Input Section */
    .input-group {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .input {
      flex: 1;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      outline: none;
      transition: all 0.3s ease;
      font-family: 'JetBrains Mono', monospace;
    }

    .input:focus {
      border-color: var(--text-primary);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
    }

    .input::placeholder {
      color: var(--text-muted);
    }

    /* Drop Area */
    .drop-area {
      border: 2px dashed var(--border-color);
      border-radius: 16px;
      padding: 3rem;
      text-align: center;
      background: rgba(17, 17, 17, 0.3);
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 1.5rem;
    }

    .drop-area:hover,
    .drop-area.dragover {
      border-color: var(--text-primary);
      background: rgba(0, 0, 0, 0.5);
      transform: scale(1.02);
    }

    .drop-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.7;
    }

    /* QR Code Display */
    .qr-display {
      text-align: center;
      padding: 2rem;
    }

    .qr-code-container {
      display: inline-block;
      padding: 1rem;
      background: white;
      border-radius: 12px;
      margin-bottom: 1rem;
    }

    .qr-code-img {
      width: 300px;
      height: 300px;
      max-width: 100%;
    }

    .qr-url {
      font-family: 'JetBrains Mono', monospace;
      background: rgba(0, 0, 0, 0.5);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      word-break: break-all;
      font-size: 0.9rem;
    }

    /* History */
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .history-list {
      max-height: 300px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border-color) transparent;
    }

    .history-list::-webkit-scrollbar {
      width: 6px;
    }

    .history-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .history-list::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid transparent;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .history-item:hover {
      border-color: var(--border-color);
      transform: translateX(8px);
      background: rgba(0, 0, 0, 0.5);
    }

    .history-url {
      color: var(--text-secondary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      flex: 1;
      margin-right: 1rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 2rem;
      right: 2rem;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-weight: 500;
      transform: translateX(400px);
      transition: all 0.3s ease;
      z-index: 1000;
      backdrop-filter: blur(10px);
      max-width: 350px;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }

    .toast.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      border-radius: 50%;
      border-top-color: var(--text-primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Animations */
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .input-group {
        flex-direction: column;
      }
      
      .toggle-container {
        flex-direction: column;
        width: 100%;
        max-width: 300px;
      }
      
      .toggle-btn {
        justify-content: center;
      }
      
      .toast {
        top: 1rem;
        right: 1rem;
        left: 1rem;
        transform: translateY(-100px);
        max-width: none;
      }
      
      .toast.show {
        transform: translateY(0);
      }
    }

    /* Hidden class */
    .hidden {
      display: none !important;
    }

    /* Icons */
    .icon {
      width: 1.25rem;
      height: 1.25rem;
      fill: currentColor;
    }
  </style>
</head>
<body>
  <!-- Galaxy Background -->
  <div class="galaxy-bg"></div>
  <div class="stars" id="stars"></div>
  <div class="nebula"></div>

  <!-- Main Container -->
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1 class="title">QR GALACTIC</h1>
      <p class="subtitle">Evrenin derinliklerinden QR kodlarınızı okuyun ve oluşturun</p>
    </div>

    <!-- Mode Toggle -->
    <div class="mode-toggle">
      <div class="toggle-container">
        <button class="toggle-btn active" id="scannerBtn" onclick="switchMode('scanner')">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
            <circle cx="12" cy="13" r="3"/>
          </svg>
          Tarayıcı
        </button>
        <button class="toggle-btn" id="generatorBtn" onclick="switchMode('generator')">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect width="5" height="5" x="3" y="3" rx="1"/>
            <rect width="5" height="5" x="16" y="3" rx="1"/>
            <rect width="5" height="5" x="3" y="16" rx="1"/>
            <path d="m21 16-3.5-3.5-1 1 1.5 1.5L16 17l1 1 1.5-1.5 1 1L21 16ZM21 21l-1.5-1.5L18 21l-1-1 1.5-1.5L17 17l1-1 3.5 3.5L21 21Z"/>
          </svg>
          Oluşturucu
        </button>
      </div>
    </div>

    <!-- Scanner Section -->
    <div id="scannerSection">
      <div class="card">
        <h2 class="card-title">QR Kod Tarayıcı</h2>
        <p class="card-subtitle">QR kodunu kameraya gösterin, otomatik olarak açılacak</p>

        <div class="camera-container" id="cameraContainer">
          <video id="cameraVideo" class="camera-video hidden" autoplay playsinline muted></video>
          <canvas id="scanCanvas" class="hidden"></canvas>
          
          <div class="camera-placeholder" id="cameraPlaceholder">
            <svg class="camera-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
              <circle cx="12" cy="13" r="3"/>
            </svg>
            <p>Kamera kapalı</p>
          </div>

          <div class="scanning-overlay hidden" id="scanningOverlay">
            <div class="scan-frame">
              <div class="scan-corner top-left"></div>
              <div class="scan-corner top-right"></div>
              <div class="scan-corner bottom-left"></div>
              <div class="scan-corner bottom-right"></div>
              <div class="scan-line"></div>
            </div>
          </div>
        </div>

        <div class="btn-center">
          <button class="btn btn-primary" id="cameraToggle" onclick="toggleCamera()">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
              <circle cx="12" cy="13" r="3"/>
            </svg>
            <span id="cameraToggleText">Kamerayı Başlat</span>
          </button>
        </div>
      </div>

      <!-- Scan History -->
      <div class="card" id="scanHistoryCard">
        <div class="history-header">
          <h3>Tarama Geçmişi</h3>
          <button class="btn btn-secondary" onclick="clearScanHistory()">Temizle</button>
        </div>
        <div class="history-list" id="scanHistoryList">
          <p style="text-align: center; color: var(--text-muted); padding: 2rem;">Henüz tarama yapılmadı</p>
        </div>
      </div>
    </div>

    <!-- Generator Section -->
    <div id="generatorSection" class="hidden">
      <div class="card">
        <h2 class="card-title">QR Kod Oluşturucu</h2>
        <p class="card-subtitle">URL girin veya sürükleyip bırakın</p>

        <div class="input-group">
          <input 
            type="url" 
            class="input" 
            id="urlInput" 
            placeholder="https://example.com"
            onkeydown="handleUrlInputKeydown(event)"
          >
          <button class="btn btn-primary" onclick="generateQRCode()">
            <span id="generateBtnText">Oluştur</span>
          </button>
        </div>

        <div class="drop-area" id="dropArea" onclick="document.getElementById('urlInput').focus()">
          <div class="drop-icon">🔗</div>
          <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">URL'yi buraya sürükleyin</div>
          <div style="font-size: 0.9rem; color: var(--text-muted);">veya yapıştırın (Ctrl+V)</div>
        </div>
      </div>

      <!-- QR Code Display -->
      <div class="card hidden" id="qrDisplayCard">
        <div class="qr-display">
          <h3 style="margin-bottom: 1.5rem;">Oluşturulan QR Kod</h3>
          
          <div class="qr-code-container">
            <img id="qrCodeImg" class="qr-code-img" alt="Generated QR Code">
          </div>
          
          <div class="qr-url" id="qrUrl"></div>
          
          <button class="btn btn-primary" onclick="downloadQRCode()">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7,10 12,15 17,10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            QR Kodu İndir
          </button>
        </div>
      </div>

      <!-- Generation History -->
      <div class="card" id="generationHistoryCard">
        <div class="history-header">
          <h3>Oluşturma Geçmişi</h3>
          <button class="btn btn-secondary" onclick="clearGenerationHistory()">Temizle</button>
        </div>
        <div class="history-list" id="generationHistoryList">
          <p style="text-align: center; color: var(--text-muted); padding: 2rem;">Henüz QR kod oluşturulmadı</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <script>
    // Global variables
    let currentMode = 'scanner';
    let isScanning = false;
    let stream = null;
    let scanInterval = null;
    let lastScannedUrl = '';
    let currentQRUrl = '';

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      createStars();
      loadHistories();
      checkHashMode();
      setupEventListeners();
    });

    // Create animated stars
    function createStars() {
      const starsContainer = document.getElementById('stars');
      const starCount = 100;
      
      for (let i = 0; i < starCount; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.width = Math.random() * 3 + 1 + 'px';
        star.style.height = star.style.width;
        star.style.animationDelay = Math.random() * 3 + 's';
        starsContainer.appendChild(star);
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Hash change listener
      window.addEventListener('hashchange', checkHashMode);
      
      // Drop area events
      const dropArea = document.getElementById('dropArea');
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
      });
      
      ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
      });
      
      dropArea.addEventListener('drop', handleDrop, false);
      
      // Paste event
      document.addEventListener('paste', handlePaste);
    }

    // Prevent default drag behaviors
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    // Handle file drop
    function handleDrop(e) {
      const url = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain');
      if (url) {
        document.getElementById('urlInput').value = url.trim();
        generateQRCode(url.trim());
      }
    }

    // Handle paste
    function handlePaste(e) {
      if (currentMode === 'generator' && document.activeElement === document.getElementById('dropArea')) {
        const paste = e.clipboardData.getData('text');
        if (paste && isValidUrl(paste)) {
          document.getElementById('urlInput').value = paste;
          generateQRCode(paste);
        }
      }
    }

    // Check hash for mode
    function checkHashMode() {
      const hash = window.location.hash.slice(1);
      if (hash === 'generator') {
        switchMode('generator');
      } else {
        switchMode('scanner');
      }
    }

    // Switch between modes
    function switchMode(mode) {
      currentMode = mode;
      
      // Update buttons
      document.getElementById('scannerBtn').classList.toggle('active', mode === 'scanner');
      document.getElementById('generatorBtn').classList.toggle('active', mode === 'generator');
      
      // Update sections
      document.getElementById('scannerSection').classList.toggle('hidden', mode !== 'scanner');
      document.getElementById('generatorSection').classList.toggle('hidden', mode !== 'generator');
      
      // Update hash
      window.location.hash = mode === 'generator' ? 'generator' : '';
      
      // Stop camera if switching away from scanner
      if (mode !== 'scanner' && isScanning) {
        stopCamera();
      }
    }

    // URL validation
    function isValidUrl(string) {
      try {
        const url = new URL(string.startsWith('http') ? string : 'https://' + string);
        return ['http:', 'https:'].includes(url.protocol);
      } catch (_) {
        return false;
      }
    }

    // Show toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    // Camera functions
    async function toggleCamera() {
      if (isScanning) {
        stopCamera();
      } else {
        await startCamera();
      }
    }

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });

        const video = document.getElementById('cameraVideo');
        video.srcObject = stream;
        
        // Show video, hide placeholder
        document.getElementById('cameraPlaceholder').classList.add('hidden');
        document.getElementById('scanningOverlay').classList.remove('hidden');
        video.classList.remove('hidden');
        
        // Update button
        document.getElementById('cameraToggleText').textContent = 'Kamerayı Durdur';
        document.getElementById('cameraToggle').className = 'btn btn-danger';
        
        isScanning = true;
        startScanning();
        
        showToast('Kamera başlatıldı', 'success');
      } catch (error) {
        showToast('Kameraya erişim sağlanamadı. Lütfen izinleri kontrol edin.', 'error');
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
      }
      
      // Hide video, show placeholder
      document.getElementById('cameraVideo').classList.add('hidden');
      document.getElementById('scanningOverlay').classList.add('hidden');
      document.getElementById('cameraPlaceholder').classList.remove('hidden');
      
      // Update button
      document.getElementById('cameraToggleText').textContent = 'Kamerayı Başlat';
      document.getElementById('cameraToggle').className = 'btn btn-primary';
      
      isScanning = false;
      showToast('Kamera durduruldu', 'success');
    }

    function startScanning() {
      const video = document.getElementById('cameraVideo');
      const canvas = document.getElementById('scanCanvas');
      const ctx = canvas.getContext('2d');

      const scan = () => {
        if (!isScanning || !video.videoWidth) return;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        // Try to detect QR code using BarcodeDetector if available
        if ('BarcodeDetector' in window) {
          const barcodeDetector = new BarcodeDetector({
            formats: ['qr_code']
          });

          barcodeDetector.detect(canvas)
            .then(barcodes => {
              if (barcodes.length > 0) {
                const qrCode = barcodes[0];
                handleQRDetected(qrCode.rawValue);
              }
            })
            .catch(() => {
              // Fallback - could implement jsQR here
            });
        }
      };

      // Scan every 500ms
      scanInterval = setInterval(scan, 500);
    }

    function handleQRDetected(url) {
      if (url === lastScannedUrl) return;
      
      lastScannedUrl = url;
      
      // Add to scan history
      addToScanHistory(url);
      
      showToast(`QR Kod tespit edildi: ${url}`, 'success');
      
      // Auto-open URL after delay
      setTimeout(() => {
        openUrl(url);
      }, 1000);
    }

    function openUrl(url) {
      try {
        const finalUrl = url.startsWith('http') ? url : `https://${url}`;
        window.open(finalUrl, '_blank', 'noopener,noreferrer');
        showToast(`URL açıldı: ${finalUrl}`, 'success');
      } catch (error) {
        showToast('URL açılamadı', 'error');
      }
    }

    // QR Code generation
    function handleUrlInputKeydown(event) {
      if (event.key === 'Enter') {
        generateQRCode();
      }
    }

    async function generateQRCode(inputUrl = null) {
      const url = inputUrl || document.getElementById('urlInput').value.trim();
      
      if (!url) {
        showToast('Lütfen bir URL girin', 'error');
        return;
      }

      const finalUrl = url.startsWith('http') ? url : `https://${url}`;
      
      if (!isValidUrl(finalUrl)) {
        showToast('Geçersiz URL formatı', 'error');
        return;
      }

      // Show loading
      const btnText = document.getElementById('generateBtnText');
      btnText.innerHTML = '<div class="loading"></div>';

      try {
        // Generate QR code using QR Server API
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(finalUrl)}&format=png&margin=20`;
        
        // Update display
        document.getElementById('qrCodeImg').src = qrUrl;
        document.getElementById('qrUrl').textContent = finalUrl;
        document.getElementById('qrDisplayCard').classList.remove('hidden');
        
        currentQRUrl = qrUrl;
        
        // Add to generation history
        addToGenerationHistory(finalUrl);
        
        showToast('QR kod oluşturuldu!', 'success');
        
        // Clear input if not from history
        if (!inputUrl) {
          document.getElementById('urlInput').value = '';
        }
        
      } catch (error) {
        showToast('QR kod oluşturulamadı', 'error');
      } finally {
        setTimeout(() => {
          btnText.textContent = 'Oluştur';
        }, 1000);
      }
    }

    async function downloadQRCode() {
      if (!currentQRUrl) return;

      try {
        const response = await fetch(currentQRUrl);
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `qr-code-${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showToast('QR kod indirildi!', 'success');
      } catch (error) {
        showToast('QR kod indirilemedi', 'error');
      }
    }

    // History management
    function loadHistories() {
      loadScanHistory();
      loadGenerationHistory();
    }

    function loadScanHistory() {
      const history = JSON.parse(localStorage.getItem('qr-scan-history') || '[]');
      const historyList = document.getElementById('scanHistoryList');
      
      if (history.length === 0) {
        historyList.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">Henüz tarama yapılmadı</p>';
        return;
      }
      
      historyList.innerHTML = history.map(url => `
        <div class="history-item" onclick="openUrl('${url}')">
          <span class="history-url" title="${url}">${url}</span>
          <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="event.stopPropagation(); removeFromScanHistory('${url}')">×</button>
        </div>
      `).join('');
    }

    function addToScanHistory(url) {
      let history = JSON.parse(localStorage.getItem('qr-scan-history') || '[]');
      history = history.filter(item => item !== url);
      history.unshift(url);
      
      if (history.length > 10) {
        history = history.slice(0, 10);
      }
      
      localStorage.setItem('qr-scan-history', JSON.stringify(history));
      loadScanHistory();
    }

    function removeFromScanHistory(url) {
      let history = JSON.parse(localStorage.getItem('qr-scan-history') || '[]');
      history = history.filter(item => item !== url);
      localStorage.setItem('qr-scan-history', JSON.stringify(history));
      loadScanHistory();
      showToast('URL geçmişten silindi', 'success');
    }

    function clearScanHistory() {
      if (confirm('Tüm tarama geçmişini silmek istediğinizden emin misiniz?')) {
        localStorage.removeItem('qr-scan-history');
        loadScanHistory();
        showToast('Tarama geçmişi temizlendi', 'success');
      }
    }

    function loadGenerationHistory() {
      const history = JSON.parse(localStorage.getItem('qr-generation-history') || '[]');
      const historyList = document.getElementById('generationHistoryList');
      
      if (history.length === 0) {
        historyList.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">Henüz QR kod oluşturulmadı</p>';
        return;
      }
      
      historyList.innerHTML = history.map(url => `
        <div class="history-item">
          <span class="history-url" title="${url}">${url}</span>
          <button class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;" onclick="regenerateQR('${url}')">Tekrar Oluştur</button>
        </div>
      `).join('');
    }

    function addToGenerationHistory(url) {
      let history = JSON.parse(localStorage.getItem('qr-generation-history') || '[]');
      history = history.filter(item => item !== url);
      history.unshift(url);
      
      if (history.length > 10) {
        history = history.slice(0, 10);
      }
      
      localStorage.setItem('qr-generation-history', JSON.stringify(history));
      loadGenerationHistory();
    }

    function regenerateQR(url) {
      document.getElementById('urlInput').value = url;
      generateQRCode(url);
    }

    function clearGenerationHistory() {
      if (confirm('Tüm oluşturma geçmişini silmek istediğinizden emin misiniz?')) {
        localStorage.removeItem('qr-generation-history');
        loadGenerationHistory();
        showToast('Oluşturma geçmişi temizlendi', 'success');
      }
    }
  </script>
</body>
</html>